\newpage
\appendix

\section{My Memo}

\subsection{To be investigated}

\begin{itemize}

	\item [HM] do we fix the anchor like ACT? | marginal. Queued.

	\item [GA] Re-design Gradual Adversary (Linear Addition)
		\[
			\big(1-\frac{\text{Clip}_0^{U_L}[l_{t-1}]}{U_L} \big)\times U_H
		\]
		Increase $E[H]$ to $E[H]+\alpha U_H$. $E[H]$ is expected to decrease
		with a well-learned model. So without GA, the strength of adversary
		will decrease.
	
	\item [M] difference between EST, ACT, AMD/ AMDsemi.
		Other methods (than HM) cannot effectively learn from the strongest
		adversary as the inner maximization is indirectly (and not guaranteed).
		HM follows the min-max paradigm (can be incorporated into FAT etc).
		Both ACT and HM stops at a specific point.
	
	\item [M] Sampling also matters in adversarial training for deep metric learning.

		[source hardness and destination hardness] different source sampling
		strategy and different destination sampling strategy. attack
		destination. DML loss not that sensitive to sampling? or generic
		advtrain method for DML? | still investigating

	\item [ICS] Adversarial training (does not allow any distance moving) may
		encourage collapse (a trivial solution to the requirement). What if we
		loosen the requirement and convert it into a new constraint? For
		instance, \[
			L=L_{base}(a,p,n)+\lambda_{1}L(a,\tilde{a},p)+\lambda_{2}L_{triplet}(a,\tilde{a},n)
		\] where the $L_{base}$ can be either $L_{triplet}$, $L_{rest}$, or
		$L_{act}$. Question: should we do this for every sample? i.e., \[
			L_{loosen}(a,p,n)=L_{base}(a,p,n)+\sum_{x\in\{a,p,n\}}L(x,\tilde{x},n_{x})
		\]

	\item [ICS] adversarial training that does not allow embedding move may
		encourage model collapse. Maybe we just apply some loosened restrction
		such as aap? i.e. $(a,\tilde{a},p;\gamma=0)$.

	\item [?] verify model collapse. are the parameters really going towards zero?

	\item [T] does the new generic HM work under FAT?
		Previous FAT leads to collapse because (even if in the amdsemi +fat
		experiment due to implementation issue) the delta is going to be universal
		so that for every input $x$ it will increase $H[L(x)]$ as much as possible.
		This is too prone to lead to collpase. Can we reuse the gradient for 
		Hardness Manipulation then? We linearly scale down the delta?
		We want to minimize $E[|H_{src}(x)-H_{dst}(x)|]$ (to a specified hardness).

	\item [T] APGD as the optimization algorithm? | postpone

	\item [T] benchmark other metric learning loss functions for adversarial
		training. Can HM or GradualAdversary be adopted for other loss functions?

	\item [T]  what about other types of metric learining loss functions? |
		investigating (we first make the most classical method work)

\end{itemize}

\subsection{Lessons Learned}

\input{direct-amd.tex}

\input{sort-hardness.tex}

\input{fat-attempt-1.tex}

\input{amdsemi.tex}

\begin{enumerate}

	\item [-] effectiveness of AMD Semi is to be verified. | as effective
		as ACT, reaches slightly higher ERS. But performs worse than ACT on
		some attacks, while performs better one some other attacks. | needs to
		be interpreted.

	\item [\cmark] 7-step PGD (as well as 16-step PGD) and better aligned comparison:
		compare when these methods reach similar retrieval performance.
		Meanwhile we can do experiments much faster.

	\item [\cmark] HM method: KL, L2, L2+threshold. L2 is $\|H_s-H_d\|^2$.
		In L2 the adversarial sample may vibrate around the boundary due to
		the minimum perturbation precision limit of $1/255$. The attacker
		may turn to reduce the hardness when $H_s>H_d$. We don't want that
		to happen.  L2+threshold (ET) is $\|\min(0,H_s-H_d)\|^2$. In this case,
		the adversarial example will not vibrate around the boundary, and will
		automatically stop when $H_s>H_d$.

	\item [\xmark] mixing amdsemi and act for adversarial training. They are good
		at different aspects. | not necessary for now. harms novelty.

	\item [\xmark] Combine and even better. | Mixing ACT and AMDsemi does result
		in clearly better results. It's on par with AMDsemi. Are they really
		that different?

	\item [\xmark] can we learn a good destination distribution? | too
		complicated? not necessary currently.

	\item [\xmark] re-design Gradual Adversary for HM based on that for the amdsemi. |
		\[
			(1-\frac{\text{prev\_loss}|_0^{2+\beta}}{2+\beta}) \times
			(\phi - H_\text{dst})\mathbb{I}\{\phi > H_\text{dst}\}
		\]
		So that for triplets that are not hard enoguh, when
		$prevloss \rightarrow 0$, $E[H_\text{dst}]\rightarrow \phi$.
		| This has a weak effect. Redesign required.
	
	\item [\cmark] revise HM. align dap dan directly instead of the loss.

	\item [\cmark] \checkmark dynamically changing schedule for amdsemi? |
		looks good | the sqrt scheme works the best. (gradually increasing the
		hardness makes sense)

	\item [\cmark] (codecheck) does amd really honour the pgditer parameter? |
		direct adoptation of madry defense is really prone to model collapse.

	\item [\xmark] MSE attack? | TMA is already close enough to it.

	\item [\xmark] Faster training (algorithm tweak) based FAT/other | this is
		a dead end. ACT has a different loss function to the outer minimization
		problem, and hence result in different gradient and we cannot reuse
		these gradients for algorithms like free adversarial training.
		Re-calculating the gradients we need would simple double the
		computational cost of the algorithm and diminish the gain from Free
		Adversarial Training. We are no longer using the core benefit of FAT in
		this way. In contrast, the AMD / AMDhm formulation can benefit from
		this setup. | Further experiments suggest very weak robustness and the
		models are very prone to collapse due to the non-zero initial delta
		(results in too hard adversarial example).  | gradient approximation
		does not look convincing. triplet gradient and ACT gradient does not
		look convertible.

	\item [\cmark] implement FAT for faster exp iteration | works on toy
		dataset. too prone to collapse. if we try to avoid model collapse, the
		adversarial robustness will decrease significantly.

	\item [\cmark] what if we use stopat for RAMD? | similar effect to amdsemi.
		misguiding gradient does not significantly affect AMD defense. So it
		is not quite necessary.
	
\end{enumerate}
